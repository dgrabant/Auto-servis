<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Auto Servis</title>
    <style>
        /* --- CSS STILOVI --- */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f4f7f6;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
    }

    /* Osigurava da radio kartice budu jedna do druge */
    .radio-row {
        display: flex;
        gap: 15px; /* Razmak između kartica */
    }

        /* Sakrivanje originalnog radio gumba */
    .radio-card input[type="radio"] {
        display: none;
    }

    /* Stiliziranje labele (koja sada glumi gumb/karticu) */
    .radio-card {
        display: block;
        cursor: pointer;
        margin-bottom: 0; 
        font-size: 1rem;
        flex-grow: 1; 
    }

    /* Stiliziranje vizualnog dijela kartice (SPAN) */
    .radio-label-text {
        display: block;
        width: 100%; 
        padding: 12px 20px;
        border-radius: 4px;
        border: 1px solid #ccc; 
        background-color: white; 
        transition: all 0.2s ease;
        text-align: center;
        font-weight: 500;
        color: #333; 
        box-sizing: border-box; 
    }

    /* Efekt prelaska mišem na kartici */
    .radio-card:hover .radio-label-text {
        background-color: #f1f1f1;
        border-color: #3498db; /* Plava boja pri prelasku mišem */
    }

    /* STANJE ODABRANOSTI: Kada je input checked, stilizira susjedni span */
    .radio-card input[type="radio"]:checked + .radio-label-text {
        background-color: #3498db; /* Plava boja iz dizajna */
        color: white;
        border-color: #2980b9;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); /* Plavi shadow */
        font-weight: 700;
    }


    #drop-zone {
        border: 2px dashed #007bff;
        border-radius: 5px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        background: #fafdff;
        color: #007bff;
        margin-bottom: 20px;
        transition: background-color 0.2s, border-color 0.2s;
    }
    #drop-zone.dragover {
        background-color: #e6f2ff;
        border-color: #0056b3;
    }
    #file-input {
        display: none;
    }
    #image-preview img {
        max-width: 150px;
        max-height: 150px;
        border-radius: 5px;
        border: 1px solid #ddd;
        object-fit: cover;
    }
    #app-container {
        max-width: 1000px; /* Malo šire zbog tablice korisnika */
        width: 100%;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: none;
    }
    .header {
        background: #2c3e50;
        padding: 20px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header h2 { margin: 0; font-size: 1.5rem; }

    #current-user-display { font-size: 0.9em; color: #bdc3c7; }
    /* TABOVI */
    .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }
    .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            transition: 0.3s;
            font-size: 1rem;
    }
    .tab-btn:hover { 
        background: #e6e6e6; 
    }
    .tab-btn.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
    }

    /* SEKCIJE */
    .content-section { padding: 25px; display: none; }
    .content-section.active { display: block; }
    /* FORME */
    .admin-form {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #eee;
        margin-bottom: 30px;
    }
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; }

    .form-group { flex: 1; }

    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }

    .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }

    .form-group textarea { resize: vertical; height: 80px; }


    /* GUMBI */
    button {
        padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .btn-primary { background-color: #3498db; color: white; width: 100%; }

    .btn-primary:hover { background-color: #2980b9; }
    
    .btn-cancel { background-color: #95a5a6; color: white; width: 100%; margin-top: 10px; display: none; }
    
    /* Akcijski gumbi u tablici */
    .btn-sm { padding: 6px 10px; font-size: 0.85em; margin-right: 5px; margin-bottom: 5px; display: inline-block;}
    .btn-edit { background-color: #f1c40f; color: #333; }
    .btn-delete { background-color: #e74c3c; color: white; }
    .btn-role { background-color: #8e44ad; color: white; } /* Ljubičasta za uloge */
    /* TABLICA */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; color: #2c3e50; }
    tr:hover { background-color: #f1f1f1; }
    .action-cell { text-align: right; min-width: 180px; }
    /* STATUS BOX */
    .status-box {
        background: #333; color: #00ff00; padding: 10px; border-radius: 4px;
        font-family: monospace; font-size: 0.85em; margin-bottom: 20px;
        min-height: 40px; display: flex; align-items: center;
    }
    
    /* Login poruka */
    #login-message { text-align:center; margin-top:50px; }
    #login-message a { color: #3498db; text-decoration: none; font-weight: bold; }
</style>
</head>
<body>

    <div id="login-message">
        <h2>Provjera autorizacije...</h2>
        <p>Učitavanje... Ako traje predugo, <a href="/index.html">prijavite se ponovno</a>.</p>
    </div>

    <div id="app-container">
        <div class="header">
            <h2>Auto Servis Admin</h2>
            <div id="current-user-display">...</div>
        </div>

        <div class="tabs">
            <button id="btn-tab-parts" class="tab-btn active">Upravljanje Dijelovima i Uslugama</button>
            <button id="btn-tab-users" class="tab-btn">Upravljanje Korisnicima</button>
        </div>

        <div id="status-display" class="status-box">Sustav spreman.</div>

        <div id="parts-section" class="content-section active">
            
            <form id="part-form" class="admin-form">
                <h3 id="part-form-title">Dodaj novi dio</h3>
                
                <div id="drop-zone">
                Povucite sliku ovdje ili **kliknite za odabir**
                <div id="image-preview"></div>
                </div>
                <input type="file" id="file-input" accept="image/*">



                <input type="hidden" id="part-id">

                <div class="form-row">
                    <div class="form-group">
                        <label>Naziv dijela:</label>
                        <input type="text" id="part-name" required maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Cijena (€):</label>
                        <input type="number" id="part-price" step="0.01" required>
                    </div>
                </div>

                <div class="form-group radio-group">
                    <label>Tip unosa:</label>
                    <div class="radio-row">
                        <label class="radio-card">
                            <input type="radio" id="type-service" name="item-type" value="usluga" checked>
                            <span class="radio-label-text">Usluga</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" id="type-part" name="item-type" value="dio">
                            <span class="radio-label-text">Dio</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Opis:</label>
                    <textarea id="part-desc"></textarea>
                </div>

                <button type="submit" class="btn-primary" id="part-save-btn">Spremi Dio</button>
                <button type="button" class="btn-cancel" id="part-cancel-btn" onclick="resetPartForm()">Odustani</button>
            </form>

            <hr>
            <h3>Popis dijelova i usluga</h3>
            <button onclick="loadParts()" class="btn-primary" style="width: auto; margin-bottom: 15px;">Dijelovi</button>
            <button onclick="loadServices()" class="btn-primary" style="width: auto; margin-bottom: 15px;">Usluge</button>
            <button onclick="loadAll()" class="btn-primary" style="width: auto; margin-bottom: 15px;">Sve</button>
            <table id="parts-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Naziv</th>
                        <th>Cijena</th>
                        <th>Slika</th>
                        <th>Dio/Usluga</th>
                        <th class="action-cell">Akcije</th>
                    </tr>
                </thead>
                <tbody id="parts-table-body"></tbody>
            </table>
        </div>

        <div id="users-section" class="content-section">
            
            <form id="user-form" class="admin-form">
                <h3>Registriraj novog korisnika</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ime korisnika:</label>
                        <input type="text" id="user-name" required maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Prezime korisnika:</label>
                        <input type="text" id="user-surname" required maxlength="50">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label id="mailText">Email:</label>
                        <input type="email" id="user-email" required maxlength="100">
                    </div>

                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Davatelj usluge:</label>
                        <select id="davUsluge">
                            <option value="google">Google</option>
                            <option value="github">Github</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Uloga:</label>
                        <select id="user-role">
                            <option value="KORISNIK">Korisnik (KORISNIK)</option>
                            <option value="ADMIN">Administrator (ADMIN)</option>
                        </select>
                    </div>
                    
                </div>

                <button type="submit" class="btn-primary">Kreiraj Korisnika</button>
            </form>

            <hr>
            <h3>Popis svih korisnika</h3>
            <button onclick="loadUsers()" class="btn-primary" style="width: auto; margin-bottom: 15px;">Osvježi listu</button>
            
            <table id="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Korisnik / Email(Username)</th>
                        <th>Uloga</th>
                        <th class="action-cell">Akcije</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- KONFIGURACIJA ---
        const API_BASE = "https://auto-servis.onrender.com/api";
        const REDIRECT_ON_FAIL = "/index.html"; 

        const partRadio = document.getElementById('type-part')
        const serviceRadio = document.getElementById('type-service')

        let dioIliUsluga = '';

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');

        // DOM Elementi - Globalni
        const appContainer = document.getElementById('app-container');
        const loginMessage = document.getElementById('login-message');
        const statusDisplay = document.getElementById('status-display');

       // --- AUTH & HELPERI ---
        function getAuthHeaders() {
            const token = localStorage.getItem("authToken");
            return {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            };
        }

        function logStatus(msg, isError = false) {
            statusDisplay.textContent = msg;
            statusDisplay.style.color = isError ? "#ff6b6b" : "#00ff00";
            if(isError) console.error(msg); else console.log(msg);
        }

        // --- INIT ---
        function initApp() {
            fetch(`${API_BASE}/korisnik/about`, {
                method: "GET",
                headers: getAuthHeaders()
            })
            .then(res => {
                if (!res.ok) throw new Error("Auth failed");
                return res.json();
            })
            .then(user => {
                loginMessage.style.display = "none";
                appContainer.style.display = "block";
                document.getElementById('current-user-display').textContent = `Prijavljen: ${user.ime || user.username || user.email} (${user.uloga})`;
                
                // Učitaj početni tab
                switchTab('parts'); 
            })
            .catch(err => {
                console.error(err);
                loginMessage.innerHTML = `<h3 style="color:red">Pristup odbijen.</h3><p><a href="${REDIRECT_ON_FAIL}">Povratak</a></p>`;
            });
        }

        //RADIO SELEKTOR LOGIKA

        function getSelectedType() {
            const odabraniElement = document.querySelector('input[name="item-type"]:checked');

            if (odabraniElement) {
                // Vraća vrijednost (value) odabranog radio gumba: 'usluga' ili 'dio'
                const odabranaVrijednost = odabraniElement.value;
                console.log(`Odabrana opcija je: ${odabranaVrijednost}`);
                return odabranaVrijednost;
            } else {
                console.log('Nijedna opcija nije odabrana.');
                return null;
            }
        }

        // --- Logika za Drag & Drop i odabir datoteke ---

        console.log("Aplikacija pokrenuta. Elementi inicijalizirani.");
        let currentFileName = ""; // Globalna varijabla za praćenje odabrane datoteke

        // Logika za klik na Drop Zone
        dropZone.addEventListener('click', (e) => {
            console.log("Kliknuto na Drop Zone. Otvara se File Manager.");
            e.preventDefault(); 
            fileInput.click();
        });
        
        // Logika kada se datoteka odabere
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            console.log(`Datoteka odabrana preko File Managera: ${file ? file.name : 'Nijedna'}`);
            handleFile(file);
        });

        // Logika za Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            // console.log("DragOver aktiviran.");
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            // console.log("DragLeave aktiviran.");
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            console.log(`Datoteka ispuštena u Drop Zone: ${file ? file.name : 'Nijedna'}`);
            handleFile(file);
        });

        function handleFile(file) {
            console.log("Obrada datoteke započeta.");
            const oldImg = imagePreview.querySelector('img');
            if (oldImg && oldImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(oldImg.src);
            }

            if (file && file.type.startsWith('image/')) {
                currentFileName = file.name; 
                const previewUrl = URL.createObjectURL(file);
                
                imagePreview.innerHTML = `
                    <img src="${previewUrl}" alt="Pregled slike">
                    <p>${currentFileName}</p>
                `;
                console.log(`Slika uspješno odabrana. Ime datoteke: ${currentFileName}`);
            } else {
                alert("Molimo odaberite valjanu slikovnu datoteku.");
                currentFileName = "";
                imagePreview.innerHTML = "";
                console.warn("Upozorenje: Pokušana je obrada ne-slikovne datoteke ili praznog unosa.");
            }
        }

        
        // --- TAB LOGIKA ---
        function switchTab(tabName) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            if(tabName === 'parts') {
                document.getElementById('parts-section').classList.add('active');
                document.getElementById('btn-tab-parts').classList.add('active');
                loadAll();
            } else {
                document.getElementById('users-section').classList.add('active');
                document.getElementById('btn-tab-users').classList.add('active');
                loadUsers();
            }
        }

        // ==============================================
        // --- 1. LOGIKA ZA DIJELOVE (PARTS) ---
        // ==============================================
        const partForm = document.getElementById('part-form');
        
        
        function OnlyLoadParts() {
            logStatus("Učitavam dijelove...");
            fetch(`${API_BASE}/dijelovi`, { headers: getAuthHeaders() })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('parts-table-body');
                data.forEach(part => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${part.idDijela}</td>
                        <td><strong>${part.naziv}</strong></td>
                        <td>${part.cijena} €</td>
                        <td>${part.slikaUrl ? 'Da' : 'Ne'}</td>
                        <td style="color: green; font-weight:bold;">DIO</td>
                        <td class="action-cell">
                            <button class="btn-sm btn-edit" onclick="preparePartEdit(${part.idDijela})">Uredi</button>
                            <button class="btn-sm btn-delete" onclick="deletePart(${part.idDijela})">Obriši</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                logStatus(`Učitano ${data.length} dijelova.`);
            })
            .catch(err => logStatus("Greška dijelovi: " + err, true));
        }
        function OnlyLoadServices() {
            logStatus("Učitavam usluge...");
            fetch(`${API_BASE}/usluga`, { headers: getAuthHeaders() })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('parts-table-body');
                data.forEach(service => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${service.idUsluge}</td>
                        <td><strong>${service.naziv}</strong></td>
                        <td>${service.cijena} €</td>
                        <td>${service.slikaUrl ? 'Da' : 'Ne'}</td>
                        <td style="color: blue; font-weight:bold;">USLUGA</td>
                        <td class="action-cell">
                            <button class="btn-sm btn-edit" onclick="prepareServiceEdit(${service.idUsluge})">Uredi</button>
                            <button class="btn-sm btn-delete" onclick="deleteService(${service.idUsluge})">Obriši</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                logStatus(`Učitano ${data.length} usluga.`);
            })
            .catch(err => logStatus("Greška dijelovi: " + err, true));
        }

        partForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('part-id').value;
            let url = '';
            const payload = {
                naziv: document.getElementById('part-name').value,
                cijena: parseFloat(document.getElementById('part-price').value),
                opis: document.getElementById('part-desc').value,
                slikaUrl: currentFileName
            };

            let method = id ? "PUT" : "POST";
            console.log("method:", method);
            if (getSelectedType()=="usluga") {
                console.log("getSelectedType() je usluga");
                if (dioIliUsluga == "dio" && method == "PUT") {
                    deletePartNoAsk(id);
                    method = "POST";
                    url = `${API_BASE}/usluga`;
                    console.log("promjena dio -> usluga");
                }
                else if (method == "PUT") {
                    url = `${API_BASE}/usluga/${id}`;
                } 
                else url = `${API_BASE}/usluga`;
            }
            else{
                console.log("getSelectedType() nije usluga");
                if (dioIliUsluga == "usluga" && method == "PUT") {
                    deleteServiceNoAsk(id);
                    method = "POST";
                    url = `${API_BASE}/dijelovi`;
                    console.log("promjena usluga -> dio");
                }
                else if (method == "PUT") {
                    url = `${API_BASE}/dijelovi/${id}`;
                } 
                else url = `${API_BASE}/dijelovi`;
            }
            console.log("url:", url);
            console.log("selektirano:", getSelectedType());
            fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(payload)
            })
            .then(res => { if(!res.ok) throw new Error(res.status); return res.json(); })
            .then(() => {
                logStatus(id ? "Dio ažuriran!" : "Dio dodan!");
                resetPartForm();
                setTimeout(() => loadAll(),1000);
                
            })
            .catch(err => logStatus("Greška spremanje: " + err, true));
        });

        // Globalne funkcije za onclick u HTML-u
        window.preparePartEdit = function(id) {
            dioIliUsluga = "dio";
            fetch(`${API_BASE}/dijelovi/${id}`, { headers: getAuthHeaders() })
            .then(res => res.json())
            .then(part => {
                document.getElementById('part-id').value = part.idDijela;
                document.getElementById('part-name').value = part.naziv;
                document.getElementById('part-price').value = part.cijena;
                partRadio.checked = true;
                serviceRadio.checked = false;
                document.getElementById('part-desc').value = part.opis || "";
                imagePreview.innerHTML = `
                    <img src="https://autoservis-progi.onrender.com/assets/pictures/djelovi/${part.slikaUrl}" alt="Pregled slike">
                    <p>${part.slikaUrl}</p>
                `; ;
                
                document.getElementById('part-form-title').textContent = `Uredi dio ID: ${part.idDijela}`;
                document.getElementById('part-save-btn').textContent = "Spremi izmjene";
                document.getElementById('part-save-btn').style.backgroundColor = "#f1c40f";
                document.getElementById('part-save-btn').style.color = "black";
                document.getElementById('part-cancel-btn').style.display = "inline-block";
                window.scrollTo(0, 0);
            });
        };
        window.prepareServiceEdit = function(id) {
            dioIliUsluga = "usluga";
            fetch(`${API_BASE}/usluga/${id}`, { headers: getAuthHeaders() })
            .then(res => res.json())
            .then(service => {
                document.getElementById('part-id').value = service.idUsluge;
                document.getElementById('part-name').value = service.naziv;
                document.getElementById('part-price').value = service.cijena;
                partRadio.checked = false;
                serviceRadio.checked = true;
                document.getElementById('part-desc').value = service.opis || "";
                imagePreview.innerHTML = `
                    <img src="https://autoservis-progi.onrender.com/assets/pictures/djelovi/${service.slikaUrl}" alt="Pregled slike">
                    <p>${service.slikaUrl}</p>
                `; ;
                
                document.getElementById('part-form-title').textContent = `Uredi dio ID: ${service.idUsluge}`;
                document.getElementById('part-save-btn').textContent = "Spremi izmjene";
                document.getElementById('part-save-btn').style.backgroundColor = "#f1c40f";
                document.getElementById('part-save-btn').style.color = "black";
                document.getElementById('part-cancel-btn').style.display = "inline-block";
                window.scrollTo(0, 0);
            });
        };

        window.deletePart = function(id) {
            if(!confirm("Sigurno obrisati dio?")) return;
            fetch(`${API_BASE}/dijelovi/${id}`, { method: "DELETE", headers: getAuthHeaders() })
            .then(() => { logStatus("Dio obrisan."); loadAll(); })
            .catch(err => logStatus("Greška brisanje: " + err, true));
        };
        window.deleteService = function(id) {
            if(!confirm("Sigurno obrisati dio?")) return;
            fetch(`${API_BASE}/usluga/${id}`, { method: "DELETE", headers: getAuthHeaders() })
            .then(() => { logStatus("Usluga obrisana."); loadAll(); })
            .catch(err => logStatus("Greška brisanje: " + err, true));
        };
        window.deletePartNoAsk = function(id) {
            fetch(`${API_BASE}/dijelovi/${id}`, { method: "DELETE", headers: getAuthHeaders() })
            .then(() => { logStatus("Dio obrisan."); loadAll(); })
            .catch(err => logStatus("Greška brisanje: " + err, true));
        };
        window.deleteServiceNoAsk = function(id) {
            fetch(`${API_BASE}/usluga/${id}`, { method: "DELETE", headers: getAuthHeaders() })
            .then(() => { logStatus("Usluga obrisana."); loadAll(); })
            .catch(err => logStatus("Greška brisanje: " + err, true));
        };

        window.resetPartForm = function() {
            partForm.reset();
            imagePreview.innerHTML = ``;
            document.getElementById('part-id').value = "";
            document.getElementById('part-form-title').textContent = "Dodaj novi dio";
            const btn = document.getElementById('part-save-btn');
            btn.textContent = "Spremi Dio";
            btn.style.backgroundColor = "#3498db";
            btn.style.color = "white";
            document.getElementById('part-cancel-btn').style.display = "none";
        };

        // ==============================================
        // --- 2. LOGIKA ZA KORISNIKE (USERS) ---
        // ==============================================
        const userForm = document.getElementById('user-form');

        // A) Učitavanje korisnika
        window.loadUsers = function() {
            logStatus("Učitavam korisnike...");
            fetch(`${API_BASE}/korisnik`, { headers: getAuthHeaders() })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = "";
                const users = Array.isArray(data) ? data : [];
                
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    
                    // Logika za gumb "Postavi Admina/Usera"
                    const isAdm = user.uloga === 'ADMIN';
                    const toggleLabel = isAdm ? "Ukloni Admina" : "Postavi Admina";
                    const roleColor = isAdm ? "red" : "green"; // Stil za tekst
                    
                    // Napomena: Escapeanje stringova u onclicku je važno
                    const roleParam = isAdm ? 'KORISNIK' : 'ADMIN';

                    tr.innerHTML = `
                        <td>${user.idKorisnik}</td>
                        <td>
                            <strong>${(user.ime + ' ' + user.prezime) || 'No Name'}</strong><br>
                            <small>${user.email || ''}</small>
                        </td>
                        <td style="color:${roleColor}; font-weight:bold;">${user.uloga}</td>
                        <td class="action-cell">
                            <button class="btn-sm btn-role" onclick="toggleUserRole(${user.idKorisnik}, '${roleParam}')">
                                ${toggleLabel}
                            </button>
                            <button class="btn-sm btn-delete" onclick="deleteUser(${user.idKorisnik})">
                                Obriši
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                logStatus(`Učitano ${users.length} korisnika.`);
            })
            .catch(err => logStatus("Greška učitavanje korisnika: " + err, true));
        };

        document.getElementById('davUsluge').addEventListener('change', (e) => {
            if (document.getElementById('davUsluge').value == "github") {
                document.getElementById('mailText').innerHTML = '';
                document.getElementById('mailText').innerHTML = 'Username';
                document.getElementById('user-email').type = 'text';
            }
            else{
                document.getElementById('mailText').innerHTML = '';
                document.getElementById('mailText').innerHTML = 'Email';
                document.getElementById('user-email').type = 'email';

            }
        });

        // B) Dodavanje novog korisnika (POST)
        userForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const newUser = {
                ime: document.getElementById('user-name').value,
                prezime: document.getElementById('user-surname').value,
                email: document.getElementById('user-email').value,
                davateljUsluge: document.getElementById('davUsluge').value,
                uloga: document.getElementById('user-role').value
            };

            logStatus("Kreiram korisnika...");
            fetch(`${API_BASE}/korisnik`, {
                method: "POST",
                headers: getAuthHeaders(),
                body: JSON.stringify(newUser)
            })
            .then(res => {
                if(!res.ok) throw new Error("Neuspjelo kreiranje (možda username postoji?)");
                return res.json();
            })
            .then(() => {
                logStatus("Korisnik uspješno kreiran!");
                userForm.reset();
                loadUsers();
            })
            .catch(err => logStatus("Greška: " + err.message, true));
        });

        // C) Brisanje korisnika (DELETE)
        window.deleteUser = function(id) {
            if(!confirm("Jeste li sigurni da želite TRAJNO obrisati ovog korisnika?")) return;

            fetch(`${API_BASE}/korisnik/${id}`, {
                method: "DELETE",
                headers: getAuthHeaders()
            })
            .then(res => {
                if(!res.ok) throw new Error(res.status);
                logStatus("Korisnik obrisan.");
                loadUsers();
            })
            .catch(err => logStatus("Greška pri brisanju: " + err, true));
        };

        // D) Promjena uloge (PUT)
        window.toggleUserRole = function(id, newRole) {
            if(!confirm(`Promijeniti ulogu korisnika (ID: ${id}) u ${newRole}?`)) return;

            // Pretpostavka API-ja: PUT na /api/korisnik/{id} s JSON tijelom
            const payload = { uloga: newRole };

            fetch(`${API_BASE}/korisnik/${id}`, {
                method: "PUT",
                headers: getAuthHeaders(),
                body: JSON.stringify(payload)
            })
            .then(res => {
                if(!res.ok) throw new Error("Greška servera pri promjeni uloge");
                return res.json();
            })
            .then(() => {
                logStatus(`Uloga promijenjena u ${newRole}.`);
                loadUsers();
            })
            .catch(err => logStatus("Greška: " + err.message, true));
        };

        // --- POKRETANJE ---
        document.addEventListener('DOMContentLoaded', () => {
            const btnParts = document.getElementById('btn-tab-parts');
            const btnUsers = document.getElementById('btn-tab-users');

            if(btnParts) btnParts.addEventListener('click', () => switchTab('parts'));
            if(btnUsers) btnUsers.addEventListener('click', () => switchTab('users'));

            initApp();
        });

        function loadAll(){
            const tbod = document.getElementById('parts-table-body');
            tbod.innerHTML="";
            OnlyLoadParts();
            OnlyLoadServices();
        }
        function loadParts(){
            const tbod = document.getElementById('parts-table-body');
            tbod.innerHTML="";
            OnlyLoadParts();
        }
        function loadServices(){
            const tbod = document.getElementById('parts-table-body');
            tbod.innerHTML="";
            OnlyLoadServices();
        }

    </script>
</body>
</html>