<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unos i slanje stavki</title>
</head>
<style>
     body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        #app-container {
            max-width: 700px;
            width: 100%;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        #item-form {
            padding: 25px;
            border-bottom: 1px solid #eee;
        }

        h2, h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        /* --- Drag and Drop Zona --- */
        #drop-zone {
            border: 2px dashed #007bff;
            border-radius: 5px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #fafdff;
            color: #007bff;
            margin-bottom: 20px;
            transition: background-color 0.2s, border-color 0.2s;
        }

        #drop-zone.dragover {
            background-color: #e6f2ff;
            border-color: #0056b3;
        }

        #file-input {
            display: none;
        }

        #image-preview {
            margin-top: 15px;
            text-align: center;
        }

        #image-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        #image-preview p {
            font-size: 0.9em;
            color: #555;
            word-break: break-all;
        }

        /* --- Polja za unos --- */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        /* --- Gumbi --- */
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        #add-btn {
            background-color: #28a745;
            color: white;
            width: 100%;
            margin-bottom: 20px;
        }
        #add-btn:hover {
            background-color: #218838;
        }

        #send-data-btn {
            background-color: #007bff;
            color: white;
            display: block;
            width: calc(100% - 50px);
            margin: 25px;
        }
        #send-data-btn:hover {
            background-color: #0056b3;
        }

        /* --- Izlaz i Status --- */
        #output-section {
            padding: 25px;
        }

        #item-list {
            list-style-type: none;
            padding: 0;
            margin-bottom: 20px;
        }
        #item-list li {
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-type {
            font-size: 0.9em;
            font-weight: bold;
            color: #007bff;
        }

        .status-box {
            background: #2c3e50;
            color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

</style>
<body>

    <div id="app-container" hidden>
        <form id="item-form">
            <h2>Dodaj novu stavku</h2>

            <div id="drop-zone">
                Povucite sliku ovdje ili **kliknite za odabir**
                <div id="image-preview"></div>
            </div>
            <input type="file" id="file-input" accept="image/*">

            <div class="form-group">
                <label for="name">Naziv:</label>
                <input type="text" id="name" required>
            </div>

            <div class="form-group">
                <label for="price">Cijena (€):</label>
                <input type="number" id="price" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="description">Opis:</label>
                <textarea id="description"></textarea>
            </div>

            <div class="form-group">
                <label>Tip unosa:</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" id="type-service" name="item-type" value="usluga" checked>
                        Usluga
                    </label>
                    <label>
                        <input type="radio" id="type-part" name="item-type" value="dio">
                        Dio
                    </label>
                </div>
            </div>

            <button type="submit" id="add-btn">Dodaj Stavku</button>
        </form>

        <div id="output-section">
            <h3>Dodane stavke:</h3>
            <ul id="item-list">
                </ul>

            <button id="send-data-btn">Pošalji podatke na Server</button>

            <h3>Status Slanja:</h3>
            <pre id="post-status" class="status-box">Kliknite na 'Pošalji podatke na Server' za početak slanja.</pre>
        </div>
    </div>

    <script>
        // --- KONFIGURACIJA API ENDPOINTA ---
        const API_URLS = {
            dio: "https://auto-servis.onrender.com/api/dijelovi",
            usluga: "https://auto-servis.onrender.com/api/usluga"
        };
        const REDIRECT_PAGE = '/index.html'; 
            


        fetch("https://auto-servis.onrender.com/api/korisnik/about", {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer "+localStorage.getItem("authToken")
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
                return response.json();
            })
        .then(data => {
            console.log("Response data:", data.uloga);
            if (data.uloga == "ADMIN") {
                document.getElementById("app-container").hidden = false;
            }
            else{
                window.location.href = REDIRECT_PAGE;
            }
        })
        .catch(error => {
            console.error("Fetch error:", error);
            window.location.href = REDIRECT_PAGE;
        });

        
        // ------------------------------------
        
        // Globalno stanje aplikacije
        let items = [];
        let currentFileName = ""; 

        // DOM Elementi
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        
        const form = document.getElementById('item-form');
        const nameInput = document.getElementById('name');
        const priceInput = document.getElementById('price');
        const descriptionInput = document.getElementById('description');
        
        const itemList = document.getElementById('item-list');
        const sendDataBtn = document.getElementById('send-data-btn');
        const postStatus = document.getElementById('post-status');

        // --- Logika za Drag & Drop i odabir datoteke ---

        console.log("Aplikacija pokrenuta. Elementi inicijalizirani.");

        // Logika za klik na Drop Zone
        dropZone.addEventListener('click', (e) => {
            console.log("Kliknuto na Drop Zone. Otvara se File Manager.");
            e.preventDefault(); 
            fileInput.click();
        });
        
        // Logika kada se datoteka odabere
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            console.log(`Datoteka odabrana preko File Managera: ${file ? file.name : 'Nijedna'}`);
            handleFile(file);
        });

        // Logika za Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            // console.log("DragOver aktiviran.");
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            // console.log("DragLeave aktiviran.");
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            console.log(`Datoteka ispuštena u Drop Zone: ${file ? file.name : 'Nijedna'}`);
            handleFile(file);
        });

        function handleFile(file) {
            console.log("Obrada datoteke započeta.");
            const oldImg = imagePreview.querySelector('img');
            if (oldImg && oldImg.src.startsWith('blob:')) {
                URL.revokeObjectURL(oldImg.src);
            }

            if (file && file.type.startsWith('image/')) {
                currentFileName = file.name; 
                const previewUrl = URL.createObjectURL(file);
                
                imagePreview.innerHTML = `
                    <img src="${previewUrl}" alt="Pregled slike">
                    <p>${currentFileName}</p>
                `;
                console.log(`Slika uspješno odabrana. Ime datoteke: ${currentFileName}`);
            } else {
                alert("Molimo odaberite valjanu slikovnu datoteku.");
                currentFileName = "";
                imagePreview.innerHTML = "";
                console.warn("Upozorenje: Pokušana je obrada ne-slikovne datoteke ili praznog unosa.");
            }
        }

        // --- Logika forme ---

        form.addEventListener('submit', (e) => {
            e.preventDefault(); 
            console.log("Pokušaj dodavanja nove stavke...");

            const name = nameInput.value;
            const price = parseFloat(priceInput.value); 
            const description = descriptionInput.value;
            const type = document.querySelector('input[name="item-type"]:checked').value;

            if (!name || isNaN(price) || !currentFileName) {
                console.error("VALIDACIJA NEUSPJELA: Nedostaje naziv, cijena ili slika.");
                alert("Molimo popunite naziv, ispravnu cijenu i dodajte sliku.");
                return;
            }
            
            let newItem = {
                name: name,
                image: currentFileName, 
                price: parseFloat(price.toFixed(2)), 
                description: description,
                type: type
            };
            
            console.log("Nova stavka kreirana:", newItem);

            items.push(newItem);
            console.log(`Stavka dodana. Ukupan broj stavki: ${items.length}`);
            renderItemsList();
            resetForm();
        });

        function renderItemsList() {
            itemList.innerHTML = "";
            items.forEach(item => {
                const li = document.createElement('li');
                const typeText = item.type.charAt(0).toUpperCase() + item.type.slice(1);
                
                li.innerHTML = `
                    <span>${item.name} - ${item.price.toFixed(2)} €</span> 
                    <span class="item-type">${typeText}</span>
                `;
                itemList.appendChild(li);
            });
            console.log("Popis stavki na UI-u je osvježen.");
        }

        function resetForm() {
            form.reset();
            const img = imagePreview.querySelector('img');
            if (img && img.src.startsWith('blob:')) {
                URL.revokeObjectURL(img.src);
            }
            imagePreview.innerHTML = "";
            currentFileName = "";
            fileInput.value = null; 
            document.getElementById('type-service').checked = true;
            nameInput.focus();
            console.log("Forma resetirana na početno stanje.");
        }

        // --- Logika slanja podataka ---
        
        async function postItem(item) {
            const endpoint = API_URLS[item.type];
            console.log(`Priprema slanja stavke "${item.name}" na endpoint: ${endpoint}`);

            const apiBody = {
                naziv: item.name,
                opis: item.description,
                cijena: item.price,
                slikaUrl: item.image
            };
            
            console.log("Tijelo POST zahtjeva:", apiBody);
            const authToken = localStorage.getItem("authToken");
            if (!authToken) {
                console.error("AUTH ERROR: authToken nije pronađen u localStorage.");
                return `GREŠKA: [${item.type.toUpperCase()}] "${item.name}". Detalji: AuthToken nije pronađen.`;
            }

            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${authToken}`
                    },
                    body: JSON.stringify(apiBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API GREŠKA za "${item.name}": Status ${response.status}`, errorText);
                    throw new Error(`HTTP error! Status: ${response.status}. Detalji: ${errorText.substring(0, 100)}...`);
                }
                
                const data = await response.json();
                console.log(`API USPJEH za "${item.name}". Odgovor servera:`, data);
                return `USPJEH: [${item.type.toUpperCase()}] "${item.name}" poslan. (ID: ${data.id || 'N/A'})`;

            } catch (error) {
                console.error(`FATALNA GREŠKA pri slanju "${item.name}":`, error.message);
                return `GREŠKA: [${item.type.toUpperCase()}] "${item.name}". Detalji: ${error.message}`;
            }
        }

        sendDataBtn.addEventListener('click', async () => {
            if (items.length === 0) {
                postStatus.textContent = "Nema dodanih stavki za slanje.";
                console.warn("KLIK: Nema stavki za slanje. Akcija prekinuta.");
                return;
            }

            console.info(`KLIK: Počinje asinkrono slanje ${items.length} stavki...`);
            postStatus.textContent = `Počinje slanje ${items.length} stavki...`;
            sendDataBtn.disabled = true;
            
            let statusMessages = ["--- Status slanja ---"];

            for (const item of items) {
                const message = await postItem(item);
                statusMessages.push(message);
                postStatus.textContent = statusMessages.join('\n');
            }

            statusMessages.push("\n--- Slanje završeno ---");
            postStatus.textContent = statusMessages.join('\n');
            sendDataBtn.disabled = false;
            console.info("SLANJE ZAVRŠENO. Gumb otključan.");
        });

    </script>
</body>
</html>